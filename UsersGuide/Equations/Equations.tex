\section{Conservation Forms}
We begin with the fully compressible equations for the conserved state vector, 
$\Ub = (\rho, \rho \ub, \rho E, \rho A_k, \rho X_k, \rho Y_k):$
\begin{eqnarray}
\frac{\partial \rho}{\partial t} &=& - \nabla \cdot (\rho \ub) + S_{{\rm ext},\rho}, \\
\frac{\partial (\rho \ub)}{\partial t} &=& - \nabla \cdot (\rho \ub \ub) - \nabla p +\rho \gb + \Sb_{{\rm ext},\rho\ub}, \\
\frac{\partial (\rho E)}{\partial t} &=& - \nabla \cdot (\rho \ub E + p \ub) + \rho \ub \cdot \gb - \sum_k {\rho q_k \dot\omega_k} + \nabla\cdot\kappa\nabla T + S_{{\rm ext},\rho E}, \\
\frac{\partial (\rho A_k)}{\partial t} &=& - \nabla \cdot (\rho \ub A_k) + S_{{\rm ext},\rho A_k}, \\
\frac{\partial (\rho X_k)}{\partial t} &=& - \nabla \cdot (\rho \ub X_k) + \rho \dot\omega_k + S_{{\rm ext},\rho X_k}, \\
\frac{\partial (\rho Y_k)}{\partial t} &=& - \nabla \cdot (\rho \ub Y_k) + S_{{\rm ext},\rho Y_k}.\label{eq:compressible-equations}
\end{eqnarray}
Here $\rho, \ub, T, p$, and $\kappa$ are the density, velocity,
temperature, pressure, and thermal conductivity, respectively, and 
$E = e + \ub \cdot \ub / 2$ is the total energy with $e$ representing the internal
energy.  In addition, $X_k$ is the abundance of the $k^{\rm th}$ isotope,
with associated production rate, $\dot\omega_k$, and
energy release, $q_k$.  Here $\gb$ is the gravitational vector,
and $S_{{\rm ext},\rho}, \Sb_{{\rm ext}\rho\ub}$, etc.,
are user-specified source terms.  $A_k$ is an advected quantity, i.e., 
a tracer.  We also carry around auxiliary variables, $Y_k$, which have a 
user-defined evolution equation, but by default are treated as advected
quantities.

In the code we also carry around $T$ and $\rho e$ in the conservative state vector
even though they are derived from the other conserved quantities.
The ordering of the elements within $\Ub$ is defined (in 3D) by integer
variables into the array---see Table~\ref{table:consints}
\begin{table}[t]
  \centering
\begin{tabular}{llp{4.5in}}
  \hline
      {\bf variable} & {\bf quantity} & {\bf note} \\
  \hline
URHO & $\rho$ \\
UMX & $\rho u$ \\
UMY & $\rho v$ \\
UMZ & $\rho w$ \\
UEDEN & $\rho E$ \\
UEINT & $\rho e$ & this is computed from the other quantities using
             $\rho e = \rho E - \rho \ub \cdot \ub / 2$ \\
UTEMP & $T$  & this is computed from the other quantities using the EOS \\
UFA & $\rho A_1$ & the first advected quantity \\
UFS & $\rho X_1$ & the first species \\
UFX & $\rho Y_1$ & the first auxiliary variable \\
\hline
\end{tabular}
\caption{\label{table:consints} The integer variables to index the conservative state array}
\end{table}

Some notes:
\begin{itemize}
\item There are {\tt nadv} advected quantities, which range from {\tt UFA: UFA+nadv-1}.
The advected quantities have no effect at all on the rest of the solution
but can be useful as tracer quantities.

\item There are {\tt nspec} species (defined in the {\tt network}
  directory), which range from {\tt UFS: UFS+nspec-1}.

\item There are {\it naux} auxiliary variables, from {\tt
  UFX:UFX+naux-1} The auxiliary variables are passed into the equation
  of state routines along with the species; An example of an auxiliary
  variable is the electron fraction, $Y_e$, in core collapse simulations.
\end{itemize}


\section{Primitive Forms}
\castro\ uses the primitive form of the fluid equations, defined in terms of
the state $\Qb = (\rho, \ub, p, \rho e, A_k, X_k, Y_k)$, to construct the
interface states that are input to the Riemann problem.

The primitive variable equations for density, velocity, and pressure are:
\begin{eqnarray}
  \frac{\partial\rho}{\partial t} &=& -\ub\cdot\nabla\rho - \rho\nabla\cdot\ub + S_{{\rm ext},\rho} \\
%
  \frac{\partial\ub}{\partial t} &=& -\ub\cdot\nabla\ub - \frac{1}{\rho}\nabla p + \gb + 
\frac{1}{\rho} (\Sb_{{\rm ext},\rho\ub} - \ub \; S_{{\rm ext},\rho}) \\
\frac{\partial p}{\partial t} &=& -\ub\cdot\nabla p - \rho c^2\nabla\cdot\ub +
\left(\frac{\partial p}{\partial \rho}\right)_{e,X}S_{{\rm ext},\rho}\nonumber\\
&&+\  \frac{1}{\rho}\sum_k\left(\frac{\partial p}{\partial X_k}\right)_{\rho,e,X_j,j\neq k}\left(\rho\dot\omega_k + S_{{\rm ext},\rho X_k} - X_kS_{{\rm ext},\rho}\right)\nonumber\\
&& +\  \frac{1}{\rho}\left(\frac{\partial p}{\partial e}\right)_{\rho,X}\left[-eS_{{\rm ext},\rho} - \sum_k\rho q_k\dot\omega_k + \nabla\cdot\kappa\nabla T \right.\nonumber\\
&& \quad\qquad\qquad\qquad+\ S_{{\rm ext},\rho E} - \ub\cdot\left(\Sb_{{\rm ext},\rho\ub} - \frac{\ub}{2}S_{{\rm ext},\rho}\right)\Biggr] 
\end{eqnarray}
We augment these with an internal energy equation:
\begin{eqnarray}
\frac{\partial(\rho e)}{\partial t} &=& - \ub\cdot\nabla(\rho e) - (\rho e+p)\nabla\cdot\ub - \sum_k \rho q_k\dot\omega_k 
                                        + \nabla\cdot\kappa\nabla T + S_{{\rm ext},\rho E} \nonumber\\
&& -\  \ub\cdot\left(\Sb_{{\rm ext},\rho\ub}-\frac{1}{2}S_{{\rm ext},\rho}\ub\right), 
\end{eqnarray}
Technically, this is redundant, but for a general equation of state, carrying around an additional
the thermodynamic quantity allows us to avoid equation of state calls.

The advected quantities appear as:
\begin{eqnarray}
\frac{\partial A_k}{\partial t} &=& -\ub\cdot\nabla A_k + \frac{1}{\rho}
                                     ( S_{{\rm ext},\rho A_k} - A_k S_{{\rm ext},\rho} ), \\
\frac{\partial X_k}{\partial t} &=& -\ub\cdot\nabla X_k + \dot\omega_k + \frac{1}{\rho}
                                     ( S_{{\rm ext},\rho X_k}  - X_k S_{{\rm ext},\rho} ), \\
\frac{\partial Y_k}{\partial t} &=& -\ub\cdot\nabla Y_k + \frac{1}{\rho} 
                                     ( S_{{\rm ext},\rho Y_k}  - Y_k S_{{\rm ext},\rho} ).
\end{eqnarray}

In the code we also carry around $T$ in the primitive state vector.
All of the primitive variables are derived from the conservative state
vector, as described in Section \ref{Sec:Compute Primitive Variables}.
When accessing the primitive variable state vector, the integer variable
keys for the different quantities are listed in Table~\ref{table:primlist}.

\begin{table}[t]
  \centering
\begin{tabular}{llp{4.5in}}
  \hline
      {\bf variable} & {\bf quantity} & {\bf note} \\
  \hline
 QRHO & $\rho$ \\
 QU & $u$ \\
 QV & $v$ \\
 QW & $w$ \\
 QPRES & $p$ \\
 QREINT & $\rho e$ \\
 QTEMP & $T$ \\
 QFA & $A_1$ & the first advected quantity \\
 QFS & $X_1$ & the first species \\
 QFX & $Y_1$ & the first auxiliary variable \\
 \hline
\end{tabular}
\caption{\label{table:primlist} The integer variable keys for accessing the
  primitive state vector}
\end{table}

The full primitive variable form (without the advected or auxiliary quantities) is
\begin{equation}
\frac{\partial\Qb}{\partial t} + \sum_d \Ab_d\frac{\partial\Qb}{\partial x_d} = \Sb_{\Qb}.
\end{equation}
For example, in 2D:
\begin{equation}
\left(\begin{array}{c}
\rho \\
u \\
v \\
p \\
\rho e \\
X_k
\end{array}\right)_t
+
\left(\begin{array}{cccccc}
u & \rho & 0 & 0 & 0 & 0 \\
0 & u & 0 & \frac{1}{\rho} & 0 & 0 \\
0 & 0 & u & 0 & 0 & 0 \\
0 & \rho c^2 & 0 & u & 0 & 0 \\
0 & \rho e + p & 0 & 0 & u & 0 \\
0 & 0 & 0 & 0 & 0 & u
\end{array}\right)
\left(\begin{array}{c}
\rho \\
u \\
v \\
p \\
\rho e \\
X_k
\end{array}\right)_x
+
\left(\begin{array}{cccccc}
v & 0 & \rho & 0 & 0 & 0 \\
0 & v & 0 & 0 & 0 & 0 \\
0 & 0 & v & \frac{1}{\rho} & 0 & 0 \\
0 & 0 & \rho c^2 & v & 0 & 0 \\
0 & 0 & \rho e + p & 0 & v & 0 \\
0 & 0 & 0 & 0 & 0 & v
\end{array}\right)
\left(\begin{array}{c}
\rho \\
u \\
v \\
p \\
\rho e \\
X_k
\end{array}\right)_y
=
\Sb_\Qb
\end{equation}
The eigenvalues are:
\begin{equation}
{\bf \Lambda}(\Ab_x) = \{u-c,u,u,u,u,u+c\}, \qquad {\bf \Lambda}(\Ab_y) = \{v-c,v,v,v,v,v+c\} .
\end{equation}
The right column eigenvectors are:
\begin{equation}
\Rb(\Ab_x) =
\left(\begin{array}{cccccc}
1 & 1 & 0 & 0 & 0 & 1 \\
-\frac{c}{\rho} & 0 & 0 & 0 & 0 & \frac{c}{\rho} \\
0 & 0 & 1 & 0 & 0 & 0 \\
c^2 & 0 & 0 & 0 & 0 & c^2 \\
h & 0 & 0 & 1 & 0 & h \\
0 & 0 & 0 & 0 & 1 & 0 \\
\end{array}\right),
\qquad
\Rb(\Ab_y) =
\left(\begin{array}{cccccc}
1 & 1 & 0 & 0 & 0 & 1 \\
0 & 0 & 1 & 0 & 0 & 0 \\
-\frac{c}{\rho} & 0 & 0 & 0 & 0 & \frac{c}{\rho} \\
c^2 & 0 & 0 & 0 & 0 & c^2 \\
h & 0 & 0 & 1 & 0 & h \\
0 & 0 & 0 & 0 & 1 & 0 \\
\end{array}\right).
\end{equation}
The left row eigenvectors, normalized so that $\Rb_d\cdot\Lb_d = \Ib$ are:
\begin{equation}
\Lb_x =
\left(\begin{array}{cccccc}
0 & -\frac{\rho}{2c} & 0 & \frac{1}{2c^2} & 0 & 0 \\
1 & 0 & 0 & -\frac{1}{c^2} & 0 & 0 \\
0 & 0 & 1 & 0 & 0 & 0 \\
0 & 0 & 0 & -\frac{h}{c^2} & 1 & 0 \\
0 & 0 & 0 & 0 & 0 & 1 \\
0 & \frac{\rho}{2c} & 0 & \frac{1}{2c^2} & 0 & 0
\end{array}\right),
\qquad
\Lb_y =
\left(\begin{array}{cccccc}
0 & 0 & -\frac{\rho}{2c} & \frac{1}{2c^2} & 0 & 0 \\
1 & 0 & 0 & -\frac{1}{c^2} & 0 & 0 \\
0 & 1 & 0 & 0 & 0 & 0 \\
0 & 0 & 0 & -\frac{h}{c^2} & 1 & 0 \\
0 & 0 & 0 & 0 & 0 & 1 \\
0 & 0 & \frac{\rho}{2c} & \frac{1}{2c^2} & 0 & 0
\end{array}\right).
\end{equation}

\section{Runtime Parameters}

A number of runtime parameters affect the hydrodynamics behavior.

\begin{itemize}
\item {\tt ppm\_reference} uses the integral under the parabola for
  the region corresponding to the fastest moving wave to the interface
  for the reference state used by the characteristic projection in
  ppm.

\item {\tt ppm\_trace\_grav} reconstructs the gravitational
  acceleration as a parabola and then constructs the integrals under
  this parabola for the three characteristic waves and then puts the
  gravitational source term into the characteristic projection when
  doing the interface states.

\item {\tt ppm\_temp\_fix} does various attempts to use the
  temperature in the reconstruction of the interface states

\item {\tt ppm\_tau\_in\_tracing} uses $\tau = 1/\rho$ instead of
  $\rho$ in the characteristic projection

\item {\tt ppm\_predict\_gammae} reconstructs $\gamma_e = p/(\rho e) + 1$
  to the interfaces and does the necessary transverse terms to aid in
  the conversion between the conserved and primitive interface states
  in the transverse flux routines.

\item {\tt ppm\_reference\_edge\_limit} uses the limit of the
  parabolic interpolant as the reference state instead of the
  cell-center value for the case when the wave is not moving toward
  the interface

\item {\tt ppm\_reference\_eigenvectors} uses the reference states in
  the evaluation of the eigenvectors for the characteristic projection

\item {\tt ppm\_flatten\_before\_integrals} does the flattening
  procedure on the parabolic coefficients before they are integrated
  to the interface states instead of the default method of flattening
  on the integrals themselves.

\item {\tt use\_flattening} turns on/off the flattening of parabola
  near shocks.

\item {\tt ppm\_flatten\_before\_integrals} applies the flattening
  to the parabolas before we integrate over the domain seen by
  each characteristic wave instead of afterwards.

\item {\tt use\_colglaz} uses the Colella \& Glaz Riemann solver to
  solve for the `star' state.
  
  
\end{itemize}



\subsection{List of Parameters}

\begin{table*}[h]
\begin{scriptsize}
\begin{center}
\begin{tabular}{|l|p{3.0in}|l|l|} \hline
Parameter & Definition & Acceptable Values &Default\\
\hline
{\bf castro.do\_hydro} & Time-advance the fluid dynamical equations & 0 if false, 1 if true &
 must be set \\
{\bf castro.do\_react} & Include reactions                          & 0 if false, 1 if true & 
 must be set \\
% {\bf castro.do\_radiation} & Include radiation                      & 0 if false, 1 if true &
%  must be set if USE\_RAD = TRUE \\
{\bf castro.add\_ext\_src} & Include additional user-specified source term & 0 if false, 1 if true & 0 \\
{\bf castro.point\_mass}   & Point mass at the center of the star & Real $\geq 0$ & 0.0 \\
{\bf castro.do\_sponge} & Call a user-supplied sponging routine after the solution update & 0 or 1 & 0 \\
{\bf castro.normalize\_species} & Enforce that $\sum_i X_i = 1$ & 0 or 1 & 0 \\
{\bf castro.fix\_mass\_flux} & Enforce constant mass flux at domain boundary & 0 or 1 & 1 \\
{\bf castro.allow\_negative\_energy} & Is internal energy allowed to be negative & 0 or 1 & 1 \\
{\bf castro.ppm\_type} & Use piecewise linear vs PPM algorithm & 0,1,2 & 1 \\
{\bf castro.ppm\_reference} & Use the integral under the parabolic interpolant as the reference state (=1; original PPM algorithm),
                              or the cell-centered quantity (=0; Castro paper) & 0,1 & 1 \\
{\bf castro.ppm\_temp\_fix} & Different methods of reconstructing using temperature information (experimental) & 0,1,2 & 0 \\
{\bf castro.ppm\_trace\_grav} & Reconstruct the gravitational acceleration as a parabola and do characteristic tracing on it? (1=yes) & 0,1 & 0 \\
{\bf castro.use\_colglaz} & Use the Colella/Glaz Riemann solver (2- and 3-d) or the original C-G algorithm (1-d)? & 0 or 1 & 0 \\
{\bf castro.cg\_maxiter} & Number of iterations for C/G algorithm & Integer & 12 \\
{\bf castro.cg\_tol} & Tolerance for C/G solver & Real & 1.0d-5 \\
{\bf castro.spherical\_star} & & 0 or 1 & 0 \\
{\bf castro.show\_center\_of\_mass} & & 0 or 1 & 0 \\
{\bf castro.small\_dens} & & Real & -1.e20 \\
{\bf castro.small\_temp} & & Real & -1.e20 \\
{\bf castro.small\_pres} & & Real & -1.e20 \\
\hline
\end{tabular}
\label{Table:Physics}
\end{center}
\end{scriptsize}
\end{table*}

\subsection{Notes}

\begin{itemize}
\item You must have USE\_POINTMASS  = TRUE in the GNUmakefile for {\bf castro.point\_mass} to be relevant.
\item {\bf castro.use\_colglaz}  = 1 is only implemented in 1D
\end{itemize}

